<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Find Your AI Tool</title>
<meta name="description" content="Find Your AI Tool â€” big search, human categories, infinite scroll, beautiful gradient cards.">
<meta name="color-scheme" content="dark light">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3CradialGradient id='g'%3E%3Cstop stop-color='%238cf6ff'/%3E%3Cstop offset='1' stop-color='%237c9cff'/%3E%3C/radialGradient%3E%3Ccircle cx='12' cy='12' r='10' fill='url(%23g)'/%3E%3C/svg%3E">

<style>
  :root {
    /* Dark dark blue â€” not black or gray */
    --bg: #061326;
    --bg-2: #0a1b38;
    --text: #eef3fb;
    --muted: #a9b4c8;
    --chip: rgba(255,255,255,.06);
    --chip-b: rgba(255,255,255,.12);
    --glass: rgba(255,255,255,.07);
    --ring: 0 0 0 2px rgba(140,246,255,.28);
    --max: 1180px;
    --radius: 18px;
    --shadow: 0 25px 60px rgba(0,0,0,.45);
    --skeleton-1: #0e2347;
    --skeleton-2: #16305e;
  }
  @media (prefers-color-scheme: light) {
    :root {
      --bg: #f7f9ff;
      --bg-2: #eaf1ff;
      --text: #0f1b2e;
      --muted: #4c5870;
      --chip: rgba(15,27,46,.04);
      --chip-b: rgba(15,27,46,.12);
      --glass: rgba(255,255,255,.75);
      --shadow: 0 18px 40px rgba(0,0,0,.08);
      --skeleton-1: #e8eefc;
      --skeleton-2: #f6f9ff;
    }
  }

  * { box-sizing: border-box }
  html, body { height: 100% }
  body {
    margin: 0;
    color: var(--text);
    font: 16px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
    background:
      radial-gradient(1200px 700px at 110% -10%, rgba(124,156,255,.25), transparent 55%),
      radial-gradient(900px 500px at -10% 10%, rgba(140,246,255,.22), transparent 55%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
    overflow-y: overlay;
  }

  /* Floating theme toggle in top right */
  .themeToggle {
    position: fixed; top: 14px; right: 14px; z-index: 50;
    border:1px solid var(--chip-b); background: var(--chip);
    color: var(--text); border-radius: 12px; padding: 8px 10px; cursor: pointer;
  }

  /* Centered hero */
  .hero {
    min-height: 56vh;
    display: grid; place-items: center;
    padding: 40px 18px 20px;
  }
  .heroInner {
    width: min(var(--max), 96vw);
    display: grid; gap: 18px; justify-items: center;
  }

  /* Liquid gradient animated title */
  .title {
    position: relative;
    font-weight: 900;
    font-size: clamp(36px, 8vw, 72px);
    letter-spacing: .2px;
    line-height: 1.02;
    text-align: center;
    background: radial-gradient(120% 120% at 20% 0%,
                #8cf6ff 0%, #7c9cff 25%, #ff75c3 50%, #ffd166 75%, #8cf6ff 100%);
    background-size: 200% 200%;
    -webkit-background-clip: text; background-clip: text; color: transparent;
    animation: flow 12s ease-in-out infinite alternate;
    filter: drop-shadow(0 14px 40px rgba(124,156,255,.25));
  }
  .title::after {
    /* liquid blobs drifting behind the text */
    content: "";
    position: absolute; inset: -14% -8%;
    background:
      radial-gradient(140px 140px at 20% 20%, rgba(255,117,195,.22), transparent 60%),
      radial-gradient(180px 160px at 80% 30%, rgba(124,156,255,.22), transparent 60%),
      radial-gradient(140px 140px at 50% 80%, rgba(140,246,255,.18), transparent 65%);
    filter: blur(16px);
    z-index: -1;
    animation: drift 18s ease-in-out infinite alternate;
  }
  @keyframes flow { 0%{background-position:0% 40%} 100%{background-position:100% 60%} }
  @keyframes drift { 0%{transform: translateY(0)} 100%{transform: translateY(-8px)} }

  /* Search row */
  .searchRow {
    display: grid; grid-template-columns: 1fr max-content; gap: 12px; align-items: center;
    width: min(820px, 96vw);
  }
  .searchWrap {
    display: flex; align-items: center; gap: 10px;
    background: var(--glass);
    border: 1px solid var(--chip-b);
    padding: 14px 16px; border-radius: 999px; box-shadow: var(--ring);
  }
  .searchWrap input {
    flex: 1; border: 0; outline: 0; background: transparent; color: var(--text);
    font-size: clamp(16px, 3.6vw, 20px);
  }
  .toggle {
    display: inline-flex; align-items: center; gap: 10px;
    background: var(--chip);
    border: 1px solid var(--chip-b);
    border-radius: 999px; padding: 10px 12px; cursor: pointer; user-select: none;
  }

  /* Chip carousel */
  .railWrap { width: min(var(--max), 96vw); }
  .rail {
    display: grid; grid-auto-flow: column; grid-auto-columns: max-content;
    gap: 8px; overflow-x: auto; padding: 8px 4px 2px;
    scroll-snap-type: x mandatory;
  }
  .rail::-webkit-scrollbar { height: 8px }
  .rail::-webkit-scrollbar-thumb { background: rgba(255,255,255,.18); border-radius: 99px }
  .chip {
    scroll-snap-align: start;
    background: var(--chip);
    border: 1px solid var(--chip-b);
    color: var(--text); padding: 8px 12px; border-radius: 999px;
    cursor: pointer; user-select: none; white-space: nowrap;
  }
  .chip[data-active="true"] { outline: 2px solid rgba(140,246,255,.45) }

  /* Sections */
  .section { width: min(var(--max), 96vw); margin: 6px auto 80px; }

  /* Grid and cards with breathing room */
  .grid {
    display: grid; gap: 20px;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    margin-top: 8px;
  }

  .card {
    position: relative;
    border-radius: var(--radius);
    min-height: 200px;
    padding: 14px;
    color: #fff;
    overflow: hidden;
    box-shadow: var(--shadow);
    background: linear-gradient(120deg,#4e61ff,#ff6f91 45%,#ffd166 95%);
    transform-style: preserve-3d;
    transition: transform .15s ease, filter .15s ease, background .2s ease;
  }
  .card::before {
    /* glossy layer */
    content:"";
    position:absolute; inset:0;
    background: radial-gradient(120% 120% at 110% -10%, rgba(255,255,255,.25), rgba(255,255,255,.05) 45%, transparent 60%);
    pointer-events:none;
  }
  .card:hover { filter: brightness(1.05) }

  .cardInner { position: relative; z-index: 1; display:grid; gap: 10px }
  .topMeta { display:flex; justify-content:space-between; align-items:center }
  .favWrap { display:flex; align-items:center; gap:8px }
  .fav { width:22px; height:22px; border-radius:5px; overflow:hidden; background:#ffffffcc; display:grid; place-items:center }
  .fav img { width:100%; height:100%; display:block }
  .price { font-size:12px; padding:6px 8px; border-radius:999px; background:#00000045; border:1px solid #ffffff55 }
  .ttl { font-weight:800; line-height:1.1; letter-spacing:.2px; font-size:17px }
  .vendor { opacity:.9; font-size:12px }
  .desc { opacity:.95; line-height:1.35 }
  .tags { display:flex; gap:6px; flex-wrap:wrap }
  .tag { font-size:12px; padding:4px 8px; border-radius:999px; background:#00000033; border:1px solid #ffffff3a }
  .tag.nsfw { background:#ff3b3b55; border-color:#ffadad }

  .btnRow { display:flex; gap:8px }
  .ghost { background:transparent; border:1px dashed #ffffff70; color:#fff; border-radius:10px; padding:7px 9px; cursor:pointer }
  .ghost:hover { border-style: solid; background:#00000028 }

  /* Skeletons */
  .skeleton {
    position: relative; overflow:hidden;
    background: linear-gradient(90deg, var(--skeleton-1), var(--skeleton-2), var(--skeleton-1));
    background-size: 200% 100%;
    animation: shimmer 1.1s linear infinite;
    border-radius: var(--radius);
    min-height: 200px;
  }
  @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

  /* Details modal */
  dialog { color:var(--text); border:1px solid var(--chip-b); background:var(--chip);
           border-radius: 16px; padding:0; width:min(760px,96vw); box-shadow: var(--shadow) }
  dialog::backdrop{ backdrop-filter: blur(10px) saturate(120%); background: rgba(0,0,0,.45) }
  .modalHead { display:flex; justify-content:space-between; align-items:center; padding:14px; border-bottom:1px solid var(--chip-b) }
  .modalBody { padding:16px; display:grid; gap:14px }
  .row { display:flex; gap:8px; flex-wrap:wrap }
  .pill { background:var(--chip); border:1px solid var(--chip-b); padding:6px 10px; border-radius:999px }
  .metaGrid { display:grid; gap:10px; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)) }
  .kv b { color:var(--muted); font-size:12px; display:block; margin-bottom:4px }

  /* NSFW confirm */
  .hidden { display:none !important }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce){
    .card { transition: none }
    .title, .title::after { animation: none }
  }
</style>
</head>
<body>

<button id="theme" class="themeToggle" title="Toggle theme">ðŸŒ“</button>

<section class="hero">
  <div class="heroInner">
    <div class="title">Find Your AI Tool</div>

    <div class="searchRow">
      <label class="searchWrap" aria-label="Search AI tools">
        <svg aria-hidden="true" width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15a7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input id="q" type="search" placeholder="Search what you want to do â€” make shorts, remove background, caption videos, write a blogâ€¦" autocomplete="off" spellcheck="false">
      </label>

      <label id="nsfwToggle" class="toggle" title="Show NSFW/18+ tools">
        <input id="nsfw" type="checkbox" style="accent-color:#ff6f91">
        <span>NSFW</span>
      </label>
    </div>

    <div class="railWrap">
      <div id="chips" class="rail" aria-label="Popular categories"></div>
    </div>
  </div>
</section>

<section class="section">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
    <div id="resultCount" style="color:var(--muted)"></div>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>
  <div id="sentinel" style="height:1px"></div>
</section>

<!-- Details modal -->
<dialog id="about">
  <div class="modalHead">
    <div>
      <div id="aboutTitle" style="font-weight:800"></div>
      <div id="aboutVendor" style="color:var(--muted); font-size:12px"></div>
    </div>
    <div style="display:flex; gap:8px">
      <a id="aboutOpen" class="pill" target="_blank" rel="noopener">Open â†—</a>
      <button class="pill" id="aboutClose">Close</button>
    </div>
  </div>
  <div class="modalBody">
    <div id="aboutDesc" style="color:var(--muted)"></div>
    <div class="row" id="aboutHuman"></div>
    <div class="row" id="aboutTags"></div>
    <div class="metaGrid">
      <div class="kv"><b>URL</b><a id="aboutUrl" href="#" target="_blank" rel="noopener" style="word-break:break-all"></a></div>
      <div class="kv"><b>Pricing</b><span id="aboutPricing"></span></div>
      <div class="kv"><b>API</b><span id="aboutApi"></span></div>
      <div class="kv"><b>Open source</b><span id="aboutOSS"></span></div>
      <div class="kv"><b>Self-hosted</b><span id="aboutSelf"></span></div>
      <div class="kv"><b>NSFW allowed</b><span id="aboutNSFW"></span></div>
      <div class="kv"><b>Status</b><span id="aboutStatus"></span></div>
      <div class="kv"><b>Release year</b><span id="aboutYear"></span></div>
      <div class="kv"><b>ID</b><span id="aboutId" style="color:var(--muted)"></span></div>
    </div>
  </div>
</dialog>

<!-- NSFW confirm -->
<dialog id="nsfwConfirm">
  <div class="modalHead">
    <div style="font-weight:800">NSFW (18+) content</div>
    <button class="pill" id="nsfwClose">Close</button>
  </div>
  <div class="modalBody">
    <p class="muted">
      Showing NSFW/18+ tools. Confirm you are 18+ and comply with local laws and each toolâ€™s terms.
    </p>
  </div>
  <div style="display:flex; gap:8px; justify-content:flex-end; padding:0 16px 16px">
    <button class="pill" id="nsfwCancel">Cancel</button>
    <button class="pill" id="nsfwProceed">I am 18+ â€” Continue</button>
  </div>
</dialog>

<script type="module">
/* --------------- Config --------------- */
const DATA_URL = './data/tools.ndjson';
const NSFW_ACK_KEY = 'fyat:nsfw:ack';
const THEME_KEY = 'fyat:theme';
const PAGE_SIZE = 36;

/* Human-facing categories (used for the chips carousel) */
const HUMAN_CATS = [
  { slug:'make-shorts',    label:'Make Shorts',      match:['video_generation','video_editing','shorts','clips','reels','autocut','i2v'] },
  { slug:'caption-videos', label:'Caption Videos',   match:['caption','captions','subtitle','subtitles','srt','speech_to_text'] },
  { slug:'translate-dub',  label:'Translate & Dub',  match:['dubbing','translate','voiceover','subtitles','text_to_speech','speech_to_text'] },
  { slug:'talking-avatars',label:'Talking Avatars',  match:['avatar_talking_head','lip-sync','talking head','video avatar'] },
  { slug:'generate-images',label:'Generate Images',  match:['image_generation'] },
  { slug:'edit-images',    label:'Edit Images',      match:['image_editing','inpaint','outpaint','erase','relight','retouch'] },
  { slug:'background-removal', label:'Background Removal', match:['background_removal','remove background','cutout'] },
  { slug:'upscale-images', label:'Upscale Images',   match:['photo_enhancement','upscale','super-resolution','sr'] },
  { slug:'face-swap',      label:'Face Swap',        match:['face swap','faceswap','roop'] },
  { slug:'transcribe-audio',label:'Transcribe Audio',match:['speech_to_text','asr','transcription'] },
  { slug:'text-to-speech', label:'Text to Speech',   match:['text_to_speech','tts'] },
  { slug:'voice-clone',    label:'Voice Clone',      match:['voice_cloning','voice clone'] },
  { slug:'make-music',     label:'Make Music',       match:['music_generation','audio_music','song'] },
  { slug:'chatbots',       label:'Chatbots',         match:['chatbot','chat_search_engine','agents_as_service','customer_support','roleplay_chat'] },
  { slug:'write-blogs',    label:'Write Blogs & Posts', match:['docs_writing','marketing_seo','blog','writing','copy'] },
  { slug:'code-generation',label:'Code Generation',  match:['code_development','ide_extensions'] },
  { slug:'meeting-notes',  label:'Meeting Notes',    match:['meeting_assistant'] },
  { slug:'ask-docs',       label:'Ask Your Documents', match:['retrieval_rag','pdf_tools','knowledge_base','knowledge_extraction'] },
  { slug:'scan-ocr',       label:'Scan & OCR',       match:['ocr_docai','ocr'] },
  { slug:'presentations',  label:'Presentations',    match:['slides','presentation','deck','productivity_suite'] },
  { slug:'spreadsheets',   label:'Spreadsheets',     match:['sheets','table','spreadsheet','analytics_bi'] },
  { slug:'research-papers',label:'Research Papers',  match:['research_search','papers','literature'] },
  { slug:'education',      label:'Education & Tutors', match:['education','tutor'] },
  { slug:'support-bots',   label:'Customer Support Bots', match:['customer_support'] },
  { slug:'nsfw-images',    label:'NSFW Image Generation', nsfw:true, match:['nsfw_image_generation','nsfw_adult'] },
  { slug:'nsfw-chat',      label:'NSFW Chat & Companions', nsfw:true, match:['nsfw_chatbots','nsfw_adult','dating_girlfriend','roleplay_chat'] },
];

/* Palettes for lively card gradients */
const PALETTES = [
  ['#4e61ff','#ff6f91','#ffd166'],
  ['#00c2ff','#7a5cff','#ff7ad9'],
  ['#00f5a0','#00d9f5','#7c9cff'],
  ['#ff9966','#ff5e62','#ffd26f'],
  ['#5ee7df','#b490ca','#ff758c'],
  ['#70e1f5','#ffd194','#fcb69f'],
];

/* --------------- State & DOM --------------- */
const el = {
  theme: document.getElementById('theme'),
  q: document.getElementById('q'),
  nsfwToggle: document.getElementById('nsfw'),
  chips: document.getElementById('chips'),
  grid: document.getElementById('grid'),
  count: document.getElementById('resultCount'),
  sentinel: document.getElementById('sentinel'),
  about: document.getElementById('about'),
  aboutClose: document.getElementById('aboutClose'),
  aboutOpen: document.getElementById('aboutOpen'),
  aboutUrl: document.getElementById('aboutUrl'),
  aboutTitle: document.getElementById('aboutTitle'),
  aboutVendor: document.getElementById('aboutVendor'),
  aboutDesc: document.getElementById('aboutDesc'),
  aboutHuman: document.getElementById('aboutHuman'),
  aboutTags: document.getElementById('aboutTags'),
  aboutPricing: document.getElementById('aboutPricing'),
  aboutApi: document.getElementById('aboutApi'),
  aboutOSS: document.getElementById('aboutOSS'),
  aboutSelf: document.getElementById('aboutSelf'),
  aboutNSFW: document.getElementById('aboutNSFW'),
  aboutStatus: document.getElementById('aboutStatus'),
  aboutYear: document.getElementById('aboutYear'),
  aboutId: document.getElementById('aboutId'),
  nsfwConfirm: document.getElementById('nsfwConfirm'),
  nsfwCancel: document.getElementById('nsfwCancel'),
  nsfwClose: document.getElementById('nsfwClose'),
  nsfwProceed: document.getElementById('nsfwProceed'),
};

const state = {
  q: '',
  nsfw: false,
  humanCat: '',
  page: 0,
};

let TOOLS = [];
let INDEX = [];
let HUMAN_MAP = new Map();
let results = [];
let observer;

/* --------------- Theme --------------- */
const savedTheme = localStorage.getItem(THEME_KEY);
if (savedTheme === 'light') document.documentElement.style.colorScheme = 'light';
el.theme.addEventListener('click', () => {
  const isLight = getComputedStyle(document.documentElement).colorScheme === 'light';
  document.documentElement.style.colorScheme = isLight ? 'dark' : 'light';
  localStorage.setItem(THEME_KEY, isLight ? 'dark' : 'light');
});

/* --------------- Init --------------- */
init();

async function init(){
  renderSkeleton(12);
  TOOLS = await fetchNDJSON(DATA_URL);
  preprocess();
  buildChips();
  bindUI();
  runSearch(true);
  setupInfinite();
}

/* --------------- Data & preprocess --------------- */
async function fetchNDJSON(url){
  const res = await fetch(url, { cache:'no-store' });
  if(!res.ok) throw new Error('Failed to load data');
  const text = await res.text();
  const out=[];
  text.split(/\r?\n/).forEach(line=>{
    if(!line.trim()) return;
    try{ out.push(JSON.parse(line)); }catch{}
  });
  return out;
}

function preprocess(){
  // Build human category hits per tool
  for (const t of TOOLS){
    const L = (x)=>String(x||'').toLowerCase();
    const tags = (t.tags||[]).map(L);
    const cats = (t.categories||[]).map(L);
    const hay = [L(t.name), L(t.vendor), L(t.description), ...tags, ...cats].join(' ');

    const hits = [];
    for (const hc of HUMAN_CATS){
      if (hc.nsfw && t.nsfw_allowed !== 'yes') continue;
      const matched = hc.match.some(m => hay.includes(L(m)));
      if (matched) hits.push(hc.slug);
    }
    if (hits.length === 0) {
      if (cats.includes('image_generation')) hits.push('generate-images');
      if (cats.includes('video_generation')) hits.push('make-shorts');
      if (cats.includes('speech_to_text')) hits.push('transcribe-audio');
      if (cats.includes('text_to_speech')) hits.push('text-to-speech');
      if (cats.includes('docs_writing')) hits.push('write-blogs');
      if (cats.includes('code_development')) hits.push('code-generation');
      if (cats.includes('retrieval_rag')||cats.includes('pdf_tools')) hits.push('ask-docs');
    }
    HUMAN_MAP.set(t.id, hits);
  }

  // Simple folded-text search index
  INDEX = TOOLS.map((t,i)=>{
    const text = [
      t.name, t.vendor, t.description,
      ...(t.tags||[]), ...(t.categories||[]),
      ...(HUMAN_MAP.get(t.id)||[])
    ].filter(Boolean).join(' ').toLowerCase()
     .normalize('NFKD').replace(/[\u0300-\u036f]/g,'');
    return { i, text };
  });
}

/* --------------- UI build --------------- */
function buildChips(){
  const frag = document.createDocumentFragment();
  HUMAN_CATS.filter(c=>!c.nsfw).forEach(h=>{
    const b = document.createElement('button');
    b.className = 'chip';
    b.textContent = h.label;
    b.dataset.slug = h.slug;
    b.addEventListener('click', ()=>{
      const active = state.humanCat === h.slug ? '' : h.slug;
      state.humanCat = active;
      [...el.chips.children].forEach(x=>x.dataset.active='false');
      if (active) b.dataset.active = 'true';
      runSearch(true);
      // smooth scroll to grid when selecting a chip
      const top = document.querySelector('.section').offsetTop - 10;
      window.scrollTo({ top, behavior:'smooth' });
    });
    frag.appendChild(b);
  });
  el.chips.innerHTML = ''; el.chips.appendChild(frag);
}

function bindUI(){
  el.q.addEventListener('input', debounce(()=>{
    state.q = el.q.value.trim();
    runSearch(true);
  }, 70));

  // NSFW toggle + confirm
  el.nsfwToggle.addEventListener('change', ()=>{
    if (el.nsfwToggle.checked) {
      if (!localStorage.getItem(NSFW_ACK_KEY)) {
        el.nsfwToggle.checked = false;
        el.nsfwConfirm.showModal();
        return;
      }
      state.nsfw = true;
    } else {
      state.nsfw = false;
    }
    runSearch(true);
  });
  el.nsfwCancel.addEventListener('click', ()=>el.nsfwConfirm.close());
  el.nsfwClose.addEventListener('click', ()=>el.nsfwConfirm.close());
  el.nsfwProceed.addEventListener('click', ()=>{
    localStorage.setItem(NSFW_ACK_KEY,'1');
    el.nsfwConfirm.close();
    el.nsfwToggle.checked = true;
    state.nsfw = true;
    runSearch(true);
  });

  // Details modal close
  el.aboutClose.addEventListener('click', ()=>el.about.close());

  // Focus search shortcut
  window.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key.toLowerCase() === 'k'){
      e.preventDefault(); el.q.focus();
    }
  });
}

/* --------------- Search & render --------------- */
function runSearch(reset){
  if (reset) {
    state.page = 0;
    el.grid.innerHTML = '';
    renderSkeleton(12);
  }

  const tokens = tokenize(state.q);
  results = [];
  const yearNow = new Date().getFullYear();

  for (let idx = 0; idx < TOOLS.length; idx++){
    const t = TOOLS[idx];
    if (!state.nsfw && t.nsfw_allowed === 'yes') continue;

    if (state.humanCat){
      const hc = HUMAN_MAP.get(t.id) || [];
      if (!hc.includes(state.humanCat)) continue;
    }

    if (tokens.length){
      const hay = INDEX[idx].text;
      let matched = true; let score=0;
      for (const tok of tokens){
        if (hay.includes(tok)){
          score += 10;
          if (inc(t.name, tok)) score += 30;
          if ((t.tags||[]).some(tag=>inc(tag,tok))) score += 12;
          if ((HUMAN_MAP.get(t.id)||[]).some(h=>h.includes(tok))) score += 8;
        } else if (tok.length >= 4 && (close1(tok, (t.name||'').toLowerCase()) || (t.tags||[]).some(tag=>close1(tok, String(tag).toLowerCase())))){
          score += 8;
        } else { matched = false; break; }
      }
      if (!matched) continue;
      results.push({t, score});
    } else {
      results.push({t, score:1});
    }

    if ((t.release_year||0) >= yearNow-1) results[results.length-1].score += 3;
  }

  results.sort((a,b)=> b.score - a.score || a.t.name.localeCompare(b.t.name));
  el.count.textContent = `${results.length.toLocaleString()} tools`;
  el.grid.innerHTML = ''; // clear skeletons before first page
  renderNextPage();
}

function renderNextPage(){
  const start = state.page * PAGE_SIZE;
  const end = Math.min(results.length, start + PAGE_SIZE);
  if (start >= end) return;

  const frag = document.createDocumentFragment();
  for (let i=start; i<end; i++){
    frag.appendChild(card(results[i].t));
  }
  el.grid.appendChild(frag);
  state.page++;
}

/* --------------- Cards --------------- */
const iconIO = new IntersectionObserver((entries)=>{
  for (const e of entries){
    if (e.isIntersecting){
      const img = e.target; img.src = img.dataset.src; iconIO.unobserve(img);
    }
  }
});

function card(tool){
  const d = document.createElement('article');
  d.className = 'card';
  d.style.background = gradientFor(tool.id);

  const inner = document.createElement('div');
  inner.className = 'cardInner';

  // meta row
  const top = document.createElement('div'); top.className = 'topMeta';
  const left = document.createElement('div'); left.className = 'favWrap';
  const fav = document.createElement('div'); fav.className = 'fav';
  const img = document.createElement('img'); img.alt=''; img.loading='lazy'; img.dataset.src = favicon(tool.url);
  fav.appendChild(img); left.appendChild(fav);
  const price = document.createElement('div'); price.className = 'price'; price.textContent = tool.pricing || 'unknown';
  top.append(left, price);

  const ttl = document.createElement('div'); ttl.className = 'ttl'; ttl.textContent = tool.name;
  const vendor = document.createElement('div'); vendor.className = 'vendor'; vendor.textContent = tool.vendor || '';
  const desc = document.createElement('div'); desc.className = 'desc'; desc.textContent = tool.description || '';

  const tags = document.createElement('div'); tags.className = 'tags';
  const humans = (HUMAN_MAP.get(tool.id)||[]);
  humans.slice(0,2).forEach(h=>{
    const s=document.createElement('span'); s.className='tag'; s.textContent=label(h); tags.appendChild(s);
  });
  if (tool.nsfw_allowed === 'yes') {
    const s=document.createElement('span'); s.className='tag nsfw'; s.textContent='NSFW'; tags.appendChild(s);
  }

  const btns = document.createElement('div'); btns.className = 'btnRow';
  const open = document.createElement('button'); open.className='ghost'; open.textContent='Open â†—';
  const more = document.createElement('button'); more.className='ghost'; more.textContent='More details';
  btns.append(open, more);

  inner.append(top, ttl, vendor, desc, tags, btns);
  d.appendChild(inner);

  // Card tilt/parallax
  d.addEventListener('mousemove', (e)=>{
    const r = d.getBoundingClientRect();
    const px = (e.clientX - r.left)/r.width - 0.5;
    const py = (e.clientY - r.top)/r.height - 0.5;
    const rx = (-py * 6).toFixed(2);
    const ry = (px * 6).toFixed(2);
    d.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg) scale(1.015)`;
  });
  d.addEventListener('mouseleave', ()=>{ d.style.transform = 'rotateX(0) rotateY(0) scale(1)'; });

  // Open behavior:
  // - Clicking the card opens in a background tab and tries to keep focus here
  d.addEventListener('click', (e)=>{
    // Attempt to open without stealing focus (browser-dependent)
    const w = window.open(tool.url, '_blank', 'noopener');
    try { window.focus(); } catch {}
  });

  // Open button in details (switches focus to the new tab)
  open.addEventListener('click', (e)=>{ e.stopPropagation();
    const w = window.open(tool.url, '_blank', 'noopener'); try { w && w.focus(); } catch {}
  });

  // More details
  more.addEventListener('click', (e)=>{ e.stopPropagation(); showAbout(tool); });

  // lazy icon
  iconIO.observe(img);
  return d;
}

/* --------------- Details modal --------------- */
function showAbout(t){
  el.aboutTitle.textContent = t.name;
  el.aboutVendor.textContent = t.vendor || '';
  el.aboutDesc.textContent = t.description || '';
  el.aboutOpen.href = t.url;
  el.aboutUrl.href = t.url; el.aboutUrl.textContent = t.url;

  el.aboutPricing.textContent = t.pricing || 'â€”';
  el.aboutApi.textContent = t.api ? 'Yes' : 'No';
  el.aboutOSS.textContent = t.open_source ? 'Yes' : 'No';
  el.aboutSelf.textContent = t.self_hosted ? 'Yes' : 'No';
  el.aboutNSFW.textContent = t.nsfw_allowed || 'unknown';
  el.aboutStatus.textContent = t.status || 'active';
  el.aboutYear.textContent = t.release_year || 'â€”';
  el.aboutId.textContent = t.id || 'â€”';

  el.aboutHuman.innerHTML = '';
  (HUMAN_MAP.get(t.id)||[]).forEach(h=>{
    const s=document.createElement('span'); s.className='pill'; s.textContent=label(h); el.aboutHuman.appendChild(s);
  });

  el.aboutTags.innerHTML = '';
  (t.tags||[]).slice(0,10).forEach(tag=>{
    const s=document.createElement('span'); s.className='pill'; s.textContent=tag; el.aboutTags.appendChild(s);
  });

  if (t.nsfw_allowed === 'yes' && !state.nsfw && !localStorage.getItem(NSFW_ACK_KEY)) {
    el.nsfwConfirm.showModal(); return;
  }
  el.about.showModal();
}

/* --------------- Infinite scroll & skeletons --------------- */
function setupInfinite(){
  if (observer) observer.disconnect();
  observer = new IntersectionObserver((entries)=>{
    if(entries.some(e=>e.isIntersecting)){
      // show skeletons if loading a new page
      renderSkeleton(8);
      setTimeout(()=>{ // small delay to let skeletons flash
        // remove last batch of skeletons
        [...el.grid.querySelectorAll('.skeleton')].slice(-8).forEach(n=>n.remove());
        renderNextPage();
      }, 260);
    }
  }, { rootMargin: '1200px 0px' });
  observer.observe(el.sentinel);
}

function renderSkeleton(n){
  const frag = document.createDocumentFragment();
  for (let i=0;i<n;i++){
    const s = document.createElement('div'); s.className='skeleton';
    frag.appendChild(s);
  }
  el.grid.appendChild(frag);
}

/* --------------- Helpers --------------- */
function tokenize(q){
  if(!q) return [];
  return q.toLowerCase()
    .normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
    .split(/[^a-z0-9\.\-\+]+/).filter(Boolean);
}
function inc(f,tok){ return String(f||'').toLowerCase().includes(tok); }
function close1(a,bField){
  const b = String(bField||''); if(!b) return false;
  const words = [b, ...b.split(/[^a-z0-9]+/)];
  return words.some(w=>editLe1(a,w));
}
function editLe1(a,b){
  if(a===b) return true;
  let i=0,j=0,e=0;
  while(i<a.length && j<b.length){
    if(a[i]===b[j]){i++;j++;continue;}
    if(e===1) return false; e++;
    if(a.length>b.length) i++; else if(b.length>a.length) j++; else {i++;j++;}
  }
  if(i<a.length||j<b.length) e++;
  return e<=1;
}
function label(slug){ const c=HUMAN_CATS.find(x=>x.slug===slug); return c?c.label:slug; }
function favicon(url){
  try { const u=new URL(url); return `https://icons.duckduckgo.com/ip3/${u.hostname}.ico`; }
  catch { return ''; }
}
function gradientFor(id='x'){
  const h = hash(id);
  const p = PALETTES[h % PALETTES.length];
  return `linear-gradient(120deg, ${p[0]}, ${p[1]} 45%, ${p[2]} 95%)`;
}
function hash(s){ let h=2166136261; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h+= (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);} return (h>>>0); }
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
</script>
</body>
</html>
